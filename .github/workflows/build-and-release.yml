name: Build and Release

on:
  push:
    branches:
      - main
  workflow_dispatch:

concurrency:
  group: release
  cancel-in-progress: true

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive

      - name: Extract version from PluginMetadata
        id: version
        run: |
          VERSION=$(grep -roh 'Version *= *"[^"]*"' --include="*.cs" src/ | head -1 | sed 's/.*"\(.*\)".*/\1/')

          if [ -z "$VERSION" ]; then
            echo "::error::Could not find PluginMetadata Version"
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"

      - name: Build Cookies.Contract
        run: |
          cd deps/Cookies/Cookies.Contract
          dotnet restore
          dotnet build -c Release

      - name: Build and Publish BetterFOV
        run: |
          dotnet restore
          dotnet publish -c Release

      - name: Prepare release artifacts
        id: zip
        run: |
          TAG="${{ steps.tag.outputs.tag }}"

          rm -rf release-artifacts
          mkdir -p release-artifacts

          PUBLISH_DIR="./build/publish/BetterFOV"
          if [ ! -d "$PUBLISH_DIR" ]; then
            echo "::error::BetterFOV publish directory not found: $PUBLISH_DIR"
            exit 1
          fi

          echo "=== Staged BetterFOV contents ==="
          find "$PUBLISH_DIR" -type f | head -30

          (cd ./build/publish && zip -r "../../release-artifacts/BetterFOV-${TAG}.zip" "BetterFOV" > /dev/null)

          echo "plugin_zip=release-artifacts/BetterFOV-${TAG}.zip" >> $GITHUB_OUTPUT

      - name: Determine release tag
        id: tag
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          REPO_NAME="${{ github.event.repository.name }}"
          LATEST_TAG="$(gh release list --limit 1 --json tagName --jq '.[0].tagName' 2>/dev/null || true)"

          if [ -z "$LATEST_TAG" ] || [ "$LATEST_TAG" = "null" ]; then
            TAG="v1.0.0"
          else
            NUMERIC="$(echo "$LATEST_TAG" | sed -n 's/^v\([0-9]\+\)\.\([0-9]\+\)\.\([0-9]\+\)$/\1 \2 \3/p')"
            if [ -z "$NUMERIC" ]; then
              echo "::warning::Latest release tag '$LATEST_TAG' is not semver; resetting to v1.0.0"
              TAG="v1.0.0"
            else
              MAJOR="$(echo "$NUMERIC" | awk '{print $1}')"
              MINOR="$(echo "$NUMERIC" | awk '{print $2}')"
              PATCH="$(echo "$NUMERIC" | awk '{print $3}')"
              TAG="v${MAJOR}.${MINOR}.$((PATCH + 1))"
            fi
          fi

          TITLE="${REPO_NAME} | ${TAG}"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "Determined tag: $TAG"

      - name: Extract changelog
        id: changelog
        run: |
          NEW_TAG="${{ steps.tag.outputs.tag }}"
          CHANGELOG=""

          if [ -f "CHANGELOG.md" ]; then
            CHANGELOG=$(awk -v ver="${NEW_TAG#v}" '
              /^## \[/ {
                if (found) exit
                if ($0 ~ "\\[v?" ver "\\]") { found=1; next }
              }
              found { print }
            ' CHANGELOG.md)
          fi

          if [ -z "$CHANGELOG" ]; then
            CHANGELOG="Release ${NEW_TAG}"
          fi

          PREV_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

          {
            echo "body<<EOF"
            echo "$CHANGELOG"
            echo ""
            if [ -n "$PREV_TAG" ]; then
              echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/${PREV_TAG}...${NEW_TAG}"
            fi
            echo "EOF"
          } >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          TAG="${{ steps.tag.outputs.tag }}"
          TITLE="${{ steps.tag.outputs.title }}"

          PRERELEASE_FLAG=""
          if [[ "$TAG" == *-* ]]; then
            PRERELEASE_FLAG="--prerelease"
            echo "Detected pre-release version"
          fi

          echo "Creating release: $TAG (Title: $TITLE)"

          gh release create "$TAG" \
            --title "$TITLE" \
            --notes "${{ steps.changelog.outputs.body }}" \
            $PRERELEASE_FLAG \
            "${{ steps.zip.outputs.plugin_zip }}"

          echo "Release $TAG created successfully!"
